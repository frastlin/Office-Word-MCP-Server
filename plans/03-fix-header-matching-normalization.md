# Plan 3: Fix `replace_paragraph_block_below_header` Header Matching

**Branch:** `fix/header-matching-normalization`
**Depends on:** Plan 0 (shared test infrastructure), Plan 2 (for `_normalize_text` helper)

## Context

- **Repository:** `C:\Users\brandon\.claude\mcp\Office-Word-MCP-Server`
- **Fork origin:** `https://github.com/frastlin/Office-Word-MCP-Server.git`
- **Upstream:** `https://github.com/GongRzhe/Office-Word-MCP-Server`

## Files to modify
- `word_document_server/utils/document_utils.py` â€” functions `replace_paragraph_block_below_header` (lines 483-528) and `delete_block_under_header` (lines 441-480)

## Files to create
- `tests/conftest.py` (see Plan 0)
- `tests/test_header_replace.py`

## Dependency note

This plan reuses the `_normalize_text()` helper introduced in Plan 2. Either:
- Branch from Plan 2's branch (`fix/anchor-matching-normalization`), OR
- Branch from `main` after Plan 2 merges, OR
- Define `_normalize_text` independently if working in parallel (integration agent deduplicates)

## Root cause

Same class as Bug 2. Uses `para.text.strip().lower() == header_text.strip().lower()` for matching. Fails with invisible Unicode characters (NBSP, ZWSP) and auto-numbering prefixes that are common in .docx files generated by pandoc or Word's auto-numbering feature.

## Architecture

Two functions need updating, both in `document_utils.py`:
- `delete_block_under_header()` â€” finds header by text (line 451)
- `replace_paragraph_block_below_header()` â€” finds header by text (lines 503-509)

No changes needed to wrappers or MCP registration.

## Tests (write first, verify they fail)

| Test | Input | Expected |
|------|-------|----------|
| Exact heading match | Clean heading text "Section One" | Content replaced |
| NBSP in heading | Heading has U+00A0 instead of space | Still matches |
| Auto-numbering prefix | "1. Section One" heading, search for "Section One" | Matches via contains + heading style check |
| Heading not found | Non-existent heading text | Error with "not found" |
| Stops at next heading | Two sections with content | Only first section's content replaced |

## Implementation

### Update `delete_block_under_header` (line 451)

Current:
```python
if para.text.strip().lower() == header_text.strip().lower():
```

New (two-pass):
```python
normalized_header = _normalize_text(header_text).lower()

# Pass 1: exact normalized match
header_para = None
header_idx = None
for i, para in enumerate(doc.paragraphs):
    if _normalize_text(para.text).lower() == normalized_header:
        header_para = para
        header_idx = i
        break

# Pass 2: contains match, prefer heading-styled paragraphs
if header_para is None:
    for i, para in enumerate(doc.paragraphs):
        if is_heading_paragraph(para) and normalized_header in _normalize_text(para.text).lower():
            logger.info(f"Header matched via contains: '{para.text}' contains '{header_text}'")
            header_para = para
            header_idx = i
            break
```

### Update `replace_paragraph_block_below_header` (lines 503-509)

Same two-pass approach with `_normalize_text`. Skip TOC paragraphs as before.

## Git workflow
```bash
git checkout -b fix/header-matching-normalization
# If Plan 2 is merged to main:
#   git checkout -b fix/header-matching-normalization main
# If branching from Plan 2's branch:
#   git checkout -b fix/header-matching-normalization fix/anchor-matching-normalization

# 1. Create tests/conftest.py (Plan 0) if not present
# 2. Create tests/test_header_replace.py
# 3. Run tests, verify they fail: uv run pytest tests/test_header_replace.py -v
# 4. Implement fix in document_utils.py
# 5. Run tests, verify they pass: uv run pytest tests/test_header_replace.py -v
# 6. Run full suite: uv run pytest tests/ -v
git add tests/test_header_replace.py word_document_server/utils/document_utils.py
git commit -m "fix: normalize whitespace in header matching for replace_paragraph_block_below_header"
git push -u origin fix/header-matching-normalization
gh pr create --repo GongRzhe/Office-Word-MCP-Server \
  --title "fix: replace_paragraph_block_below_header handles NBSP and auto-numbering" \
  --body "$(cat <<'EOF'
## Summary
- Header text matching now uses Unicode NFKC normalization + whitespace collapsing
- Falls back to contains matching with heading-style preference
- Shared _normalize_text() helper (reused from anchor matching fix)
- Both delete_block_under_header and replace_paragraph_block_below_header updated

## Test plan
- [ ] Exact heading match works (regression)
- [ ] NBSP in heading text handled
- [ ] Auto-numbering prefix handled via contains + heading style fallback
- [ ] Non-existent heading returns clear error
- [ ] Replacement stops at next heading

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
EOF
)"
```

## Verification
```bash
uv run pytest tests/test_header_replace.py -v
uv run pytest tests/ -v
```
